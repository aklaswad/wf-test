on: issue_comment
name: comment test
jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      command: ${{ steps.parse.outputs.command }}
      token: ${{ steps.parse.outputs.token }}
    steps:
      - uses: actions/github-script@v6
        id: parse
        name: Parse command from issue comment
        with:
          script: |
            const comment = context.payload.comment.body
            if ( ! /^!/.test(comment) ) {
              // It's not command.
              return
            }
            const [ command, token ] = comment.substr(1).split(':')
            if ( command === 'alt-deploy-to-stating' ) {
              return { command: 'deploy-staging', token: token }
            }
            return { command: 'deploy-legacy', token: token }
  deploy-staging:
    runs-on: [ self-hosted, deploy-staging ]
    needs: parse
    if: needs.parse.outputs.command == 'deploy-staging'
    steps:
      - run: echo "deploy-staging"
  deploy-legacy:
    runs-on: ubuntu-latest
    needs: parse
    if: needs.parse.outputs.command == 'deploy-legacy'
    steps:
      - run: echo "deploy-legacy"
  dump:
    runs-on: ubuntu-latest
    needs: parse
    steps:
      - run: echo ${{needs.parse.outputs.token}} ${{needs.parse.outputs.command}} got...

